{
   "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
   "contentVersion": "1.0.0.0",
   "parameters": {
      "workspaceName": {
         "type": "string",
         "metadata": {
            "description": "Workspace name"
         }
      },
      "gpuType": {
         "type": "string",
         "allowedValues": [
            "None",
            "NVidia",
            "AMD"
         ],
         "defaultValue": "None",
         "metadata": {
            "description": "Choose the GPU type for the VM type(s) used. This will deploy the correct performance counters for the GPU type"
         }
      }
   },
   "variables": {
      "location": "[resourceGroup().location]"
   },
   "resources": [
      {
         "properties": {},
         "apiVersion": "2020-10-01",
         "type": "Microsoft.OperationalInsights/workspaces",
         "name": "[parameters('workspaceName')]",
         "location": "[variables('location')]",
         "resources": [
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "sampleWindowsEvent1",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsEvent",
               "properties": {
                  "eventLogName": "Application",
                  "eventTypes": [
                     {
                        "eventType": "Error"
                     },
                     {
                        "eventType": "Warning"
                     }
                  ]
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "sampleWindowsEvent2",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsEvent",
               "properties": {
                  "eventLogName": "System",
                  "eventTypes": [
                     {
                        "eventType": "Error"
                     },
                     {
                        "eventType": "Warning"
                     }
                  ]
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "sampleWindowsEvent3",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsEvent",
               "properties": {
                  "eventLogName": "Microsoft-Windows-TerminalServices-LocalSessionManager/Operational",
                  "eventTypes": [
                     {
                        "eventType": "Error"
                     },
                     {
                        "eventType": "Information"
                     },
                     {
                        "eventType": "Warning"
                     }
                  ]
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "sampleWindowsEvent4",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsEvent",
               "properties": {
                  "eventLogName": "Microsoft-Windows-TerminalServices-RemoteConnectionManager/Admin",
                  "eventTypes": [
                     {
                        "eventType": "Error"
                     },
                     {
                        "eventType": "Information"
                     },
                     {
                        "eventType": "Warning"
                     }
                  ]
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "sampleWindowsEvent5",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsEvent",
               "properties": {
                  "eventLogName": "Microsoft-FSLogix-Apps/Admin",
                  "eventTypes": [
                     {
                        "eventType": "Error"
                     },
                     {
                        "eventType": "Information"
                     },
                     {
                        "eventType": "Warning"
                     }
                  ]
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "sampleWindowsEvent6",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsEvent",
               "properties": {
                  "eventLogName": "Microsoft-FSLogix-Apps/Operational",
                  "eventTypes": [
                     {
                        "eventType": "Error"
                     },
                     {
                        "eventType": "Information"
                     },
                     {
                        "eventType": "Warning"
                     }
                  ]
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter1",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "LogicalDisk",
                  "instanceName": "C:",
                  "intervalSeconds": 1800,
                  "counterName": "% Free Space"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter2",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "LogicalDisk",
                  "instanceName": "C:",
                  "intervalSeconds": 240,
                  "counterName": "Avg. Disk Queue Length"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter3",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "LogicalDisk",
                  "instanceName": "C:",
                  "intervalSeconds": 240,
                  "counterName": "Avg. Disk sec/Transfer"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter4",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "LogicalDisk",
                  "instanceName": "C:",
                  "intervalSeconds": 30,
                  "counterName": "Current Disk Queue Length"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter5",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "Memory",
                  "instanceName": "*",
                  "intervalSeconds": 30,
                  "counterName": "Available Mbytes"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter6",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "Memory",
                  "instanceName": "*",
                  "intervalSeconds": 30,
                  "counterName": "Page Faults/sec"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter7",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "Memory",
                  "instanceName": "*",
                  "intervalSeconds": 30,
                  "counterName": "Pages/sec"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter8",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "Memory",
                  "instanceName": "*",
                  "intervalSeconds": 30,
                  "counterName": "% Committed Bytes In Use"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter9",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "PhysicalDisk",
                  "instanceName": "*",
                  "intervalSeconds": 240,
                  "counterName": "Avg. Disk Queue Length"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter10",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "PhysicalDisk",
                  "instanceName": "*",
                  "intervalSeconds": 240,
                  "counterName": "Avg. Disk sec/Read"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter11",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "PhysicalDisk",
                  "instanceName": "*",
                  "intervalSeconds": 240,
                  "counterName": "Avg. Disk sec/Transfer"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter12",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "PhysicalDisk",
                  "instanceName": "*",
                  "intervalSeconds": 240,
                  "counterName": "Avg. Disk sec/Write"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter18",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "Processor Information",
                  "instanceName": "_Total",
                  "intervalSeconds": 30,
                  "counterName": "% Processor Time"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter19",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "Terminal Services",
                  "instanceName": "*",
                  "intervalSeconds": 60,
                  "counterName": "Active Sessions"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter20",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "Terminal Services",
                  "instanceName": "*",
                  "intervalSeconds": 60,
                  "counterName": "Inactive Sessions"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter21",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "Terminal Services",
                  "instanceName": "*",
                  "intervalSeconds": 60,
                  "counterName": "Total Sessions"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter22",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "User Input Delay per Process",
                  "instanceName": "*",
                  "intervalSeconds": 1800,
                  "counterName": "Max Input Delay"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter23",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "User Input Delay per Session",
                  "instanceName": "*",
                  "intervalSeconds": 1800,
                  "counterName": "Max Input Delay"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter24",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "RemoteFX Network",
                  "instanceName": "*",
                  "intervalSeconds": 60,
                  "counterName": "Current TCP RTT"
               }
            },
            {
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter25",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "RemoteFX Network",
                  "instanceName": "*",
                  "intervalSeconds": 60,
                  "counterName": "Current UDP Bandwidth"
               }
            },
            {
               "condition": "[equals(parameters('gpuType'), 'NVidia')]",
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter26",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "NVIDIA GPU",
                  "instanceName": "*",
                  "intervalSeconds": 60,
                  "counterName": "Temperature C"
               }
            },
            {
               "condition": "[equals(parameters('gpuType'), 'NVidia')]",
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter27",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "NVIDIA GPU",
                  "instanceName": "*",
                  "intervalSeconds": 30,
                  "counterName": "% GPU Memory Usage"
               }
            },
            {
               "condition": "[equals(parameters('gpuType'), 'NVidia')]",
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter28",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "NVIDIA GPU",
                  "instanceName": "*",
                  "intervalSeconds": 30,
                  "counterName": "% FB Usage"
               }
            },
            {
               "condition": "[equals(parameters('gpuType'), 'NVidia')]",
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter29",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "NVIDIA GPU",
                  "instanceName": "*",
                  "intervalSeconds": 60,
                  "counterName": "% Video Usage"
               }
            },
            {
               "condition": "[equals(parameters('gpuType'), 'NVidia')]",
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter30",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "NVIDIA GPU",
                  "instanceName": "*",
                  "intervalSeconds": 60,
                  "counterName": "% Video Decoder Usage"
               }
            },
            {
               "condition": "[equals(parameters('gpuType'), 'NVidia')]",
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter31",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "NVIDIA GPU",
                  "instanceName": "*",
                  "intervalSeconds": 60,
                  "counterName": "% Video Encoder Usage"
               }
            },
            {
               "condition": "[equals(parameters('gpuType'), 'NVidia')]",
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter32",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "NVIDIA GPU",
                  "instanceName": "*",
                  "intervalSeconds": 60,
                  "counterName": "Video Encoder Sessions"
               }
            },
            {
               "condition": "[equals(parameters('gpuType'), 'NVidia')]",
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter33",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "NVIDIA GPU",
                  "instanceName": "*",
                  "intervalSeconds": 240,
                  "counterName": "Video Encoder Average Latency (ms)"
               }
            },
            {
               "condition": "[equals(parameters('gpuType'), 'NVidia')]",
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter34",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "NVIDIA GPU",
                  "instanceName": "*",
                  "intervalSeconds": 30,
                  "counterName": "% GPU Usage"
               }
            },
            {
               "condition": "[equals(parameters('gpuType'), 'NVidia')]",
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter35",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "NVIDIA GPU",
                  "instanceName": "*",
                  "intervalSeconds": 60,
                  "counterName": "% Bus Usage"
               }
            },
            {
               "condition": "[equals(parameters('gpuType'), 'NVidia')]",
               "apiVersion": "2020-10-01",
               "type": "datasources",
               "name": "perfcounter36",
               "dependsOn": [
                  "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
               ],
               "kind": "WindowsPerformanceCounter",
               "properties": {
                  "objectName": "NVIDIA GPU",
                  "instanceName": "*",
                  "intervalSeconds": 240,
                  "counterName": "Video Encoder Average FPS"
               }
            }
         ]
      }
   ],
   "outputs": {
      "workspaceName": {
         "type": "string",
         "value": "[parameters('workspaceName')]"
      },
      "provisioningState": {
         "type": "string",
         "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), '2020-10-01').provisioningState]"
      },
      "source": {
         "type": "string",
         "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), '2020-10-01').source]"
      },
      "customerId": {
         "type": "string",
         "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), '2020-10-01').customerId]"
      },
      "sku": {
         "type": "string",
         "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), '2020-10-01').sku.name]"
      }
   }
}
